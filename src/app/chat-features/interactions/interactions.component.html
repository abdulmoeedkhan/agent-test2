<div class="interaction-main" [ngClass]="{'customer-bar-opened': isBarOPened}">
  <div class="interaction-inner">
    <div [ngClass]="{'unidentified-customer':conversation.customer.isAnonymous}" class="container-fluid main-chat-bar">
      <div class="row">
        <div class="col-md-4 col-sm-4 customer-showcase">
          <h3 matTooltipPosition="right" class="customer-highlight">
            {{conversation.customer.firstName | getFirstTwoLetters}}
            <span class="channel-icon">
              <img
                [src]="conversation.activeChannelSessions[conversation.activeChannelSessions.length-1]?.channel.channelType.channelLogo | channelLogo | async">
            </span>
          </h3>
          <h5 class="customer-name" [matTooltip]="conversation.customer.firstName">
            {{conversation.customer.firstName | slice :0 :50}}
            <span class="chat-timer">( 11:32 )</span>

          </h5>
        </div>
        <div class="col-md-8 col-sm-8 agent-actions">
          <ul class="list-group list-group-horizontal agent-controls">
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon>group</mat-icon>
              </button>
            </li>
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon>history</mat-icon>
              </button>
            </li>
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon>chat_bubble</mat-icon>
                <i class="material-icons arrow-red arrow-gray">arrow_forward</i>
              </button>
            </li>
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon>person_add</mat-icon>
              </button>
            </li>
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon>pan_tool</mat-icon>
              </button>
            </li>
            <li class="list-group-item">
              <button mat-icon-button>
                <mat-icon (click)="topicUnsub()">close</mat-icon>
              </button>
            </li>
          </ul>

          <!-- Ringing controls-->
          <!-- <span *ngIf="ringing" class="ringing-controls"> Calling <strong>'+4444858988'</strong> Mobile
        <button mat-icon-button>
          <mat-icon>call_end</mat-icon>
        </button>
      </span> -->
          <!--Call controls-->
          <!-- <ul *ngIf="callControls" class="list-group list-group-horizontal agent-controls call-controls">
        <li class="list-group-item">
          <button mat-fab>
            <mat-icon>textsms</mat-icon>
          </button>
        </li>
        <li class="list-group-item">
          <button mat-fab>
            <mat-icon>phone_forwarded</mat-icon>
          </button>
        </li>
        <li class="list-group-item">
          <button mat-fab>
            <mat-icon>mic</mat-icon>
          </button>
        </li>
        <li class="list-group-item">
          <button mat-fab>
            <mat-icon>volume_off</mat-icon>
          </button>
        </li>
        <li class="list-group-item">
          <button mat-fab>
            <mat-icon>pause</mat-icon>
          </button>
        </li>
        <li class="list-group-item call-end">
          <button mat-fab>
            <mat-icon>call_end</mat-icon>
          </button>
        </li>
      </ul> -->

        </div>

      </div>

    </div>
    <!--/Top bar-->
    <!--Interactions Area Start -->
    <div id="chat-content" class="container-fluid main-chat-area">
      <div class="row">

        <ng-scrollbar class="chat-messages-main my-scrollbar"
          [style.height]="replyInput?.offsetHeight > 80 ? 'calc(100% - ' + (replyInput?.offsetHeight+80)+'px)' : 'calc(100% - '+ viewHeight+')'">
          <!-- voice message chat area -->


          <!-- simple chat area -->

          <div class="instruction-content chat-session-main">
            <div style="display: unset;" *ngFor="let message of conversation.messages; let index = index">
              <div id="datestamp" class="int-date"
                *ngIf="(index == 0) || (message.header.timestamp | date: 'dd MMMM yyyy') != (conversation.messages[index-1].header.timestamp | date: 'dd MMMM yyyy')">
                <!-- <span>{{message.header.timestamp | date: 'MMM'}}<b>{{message.header.timestamp | date: 'dd'}}</b></span> -->
                <span>{{message.header.timestamp | amCalendar:{sameDay: '[Today]',
                  nextDay: '[Tomorrow]',
                  nextWeek: 'dddd',
                  lastDay: '[Yesterday]',
                  lastWeek: '[Last] dddd',
                  sameElse: 'dddd, MMM YYYY'} }}</span>
              </div>
              <div
                class="chat-message {{message.header.status=='sending' ? 'low-opacity' : ''}}  {{message.body.type | lowercase}} {{  message.header.replyToMessageId != null  ? 'quoted-message-main' : ''}}"
                [ngClass]=" ((message.header.sender.type | lowercase) == 'customer') ?'user-message slide-in-left':'agent-message ' ">
                <div class="profile-pic">
                  <div class="active-channel channel-icon">
                    <img width="20"
                      [src]="message.header.channelSession.channel.channelType.channelLogo | channelLogo | async">
                  </div>
                  <div *ngIf="(message.header.sender.type | lowercase) != 'bot'" class="profile-pic-area user-img">
                    {{message.header.sender | getSenderName:conversation.customer:true}}</div>
                  <div *ngIf="(message.header.sender.type | lowercase) == 'bot'" class="profile-pic-area user-img"><img
                      src="assets/images/robot-dark.svg">
                  </div>
                </div>
                <div class="combined-area">
                  <!-- -----------------------referred reply message---------------- -->

                  <div class="chat-message-content referred-message-content"
                    *ngIf="message.header.replyToMessageId != null">
                    <div class="main-quoted-reply"
                      *ngFor="let referredMessage of message.header.replyToMessageId | getReferredMsg:conversation.messages">
                      <div
                        [ngClass]="{'file-type-message' : (referredMessage.body.type | lowercase) === 'image'||  (referredMessage.body.type | lowercase) === 'file' || (referredMessage.body.type | lowercase) === 'url' || (referredMessage.body.type | lowercase) === 'contact'|| (referredMessage.body.type | lowercase) === 'location' || (referredMessage.body.type | lowercase) === 'video' || (referredMessage.body.type | lowercase) === 'sticker', 'file-type-video' : (referredMessage.body.type | lowercase) === 'video', 'file-type-sticker' : (referredMessage.body.type | lowercase) === 'sticker' }">
                        <!-- ---------------plain---------------------- -->
                        <div *ngIf="(referredMessage.body.type | lowercase) == 'plain'">
                          <p>
                            <span [innerHTML]="referredMessage.body.markdownText | linkify | ibsformat"></span>
                            <!--                      <span class="message-stamp">-->
                            <!--                         <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                            <!--                      </span>-->

                        </div>

                        <!-- ---------------button---------------------- -->
                        <div *ngIf="(referredMessage.body.type | lowercase) == 'button'">
                          <!--                    <p [innerHTML]="message.body.markdownText | linkify | ibsformat"></p>-->
                          <!--                    <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>-->

                          <p>
                            <span [innerHTML]="referredMessage.body.markdownText | linkify | ibsformat"></span>
                            <!--                      <span class="message-stamp">-->
                            <!--                         <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                            <!--                      </span>-->
                          </p>


                          <ul class="structured-actions">
                            <li *ngFor="let button of referredMessage.body.buttons">{{button.title}}</li>
                          </ul>
                          <!-- <button mat-icon-button class="user_settings"
                      *ngIf="((message.header.sender.type | lowercase) == 'customer') && message.botSuggestions"
                      (click)="message.showBotSuggestions =! message.showBotSuggestions ">
                    </button> -->
                        </div>

                        <!-- --------------------sticker--------------------- -->
                        <div *ngIf="(referredMessage.body.type | lowercase) == 'sticker'" class="file-type-content ">
                          <span class="display-file">
                            <img [src]="referredMessage.body.mediaUrl | getFileUrl">
                          </span>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- --------------------image--------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'image'"
                          class="file-type-content image-content">
                          <a style="cursor: pointer;"
                            (click)="filePreviewOpener(referredMessage.body.attachment.mediaUrl, referredMessage.body.caption,'image' )"
                            class="display-file display-image">
                            <img [src]="referredMessage.body.attachment.mediaUrl | getFileUrl">
                          </a>
                          <div class="shared-url shared-card-content">
                            <span class="url-title card-title"
                              [matTooltip]="referredMessage.body.caption">{{referredMessage.body.caption}}</span>
                            <span class="url-description card-description"></span>
                            <a class="url-link  card-action"
                              [matTooltip]="referredMessage.body.markdownText">{{referredMessage.body.markdownText}}</a>
                          </div>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- ---------------------file-------------------------------- -->

                        <div style="cursor: pointer;"
                          (click)="filePreviewOpener(referredMessage.body.attachment.mediaUrl, referredMessage.body.additionalDetails.fileName,'file' )"
                          *ngIf="(referredMessage.body.type | lowercase) == 'file'" class="file-type-content">
                          <span class="display-file">
                            <img src="assets/file-types/{{referredMessage.body.attachment.mimeType | getFileExt}}.svg">
                          </span>
                          <span class="display-file-name">

                            <span class="show-file-name"
                              [matTooltip]="referredMessage.body.additionalDetails.fileName">{{referredMessage.body.additionalDetails.fileName}}</span>
                            <span class="file-size">{{referredMessage.body.attachment.size | getFormattedBytes}}</span>
                            <a (click)="$event.stopPropagation();" class="file-download"
                              href="{{referredMessage.body.attachment.mediaUrl | getFileUrl}}"
                              [download]="referredMessage.body.additionalDetails.fileName" [attr.disabled]="dwld.busy"
                              #dwld="wmDownload">
                              Download
                            </a>

                          </span>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- -----------------------contact---------------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'contact'"
                          class="file-type-content contact-type">
                          <span class="display-file contact-logo">
                            <!--                      <img src="assets/images/contacts-logo.svg">-->
                            <img
                              src="assets/images/{{referredMessage.header.sender.type == 'CUSTOMER' ? 'contacts-logo.svg' :  'contacts-logo-bot.svg'}}">

                          </span>
                          <div class="contact-space shared-url shared-card-content">
                            <div class="contact-inner" *ngFor="let contact of referredMessage.body.contacts">
                              <span class="contact-name card-title"
                                [matTooltip]="contact.name.formattedName">{{contact.name.formattedName}}</span>
                              <span class="contact-number card-description">{{contact.phones[0].phone}}</span>
                            </div>
                          </div>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- ------------------------------url------------------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'url'"
                          class="file-type-content url-content">
                          <a class="display-file url-image" href="{{referredMessage.body.mediaUrl}}" target="_blank">
                            <img src="assets/images/url.png">
                          </a>
                          <div class="shared-url shared-card-content">
                            <span class="url-title card-title"
                              [matTooltip]="referredMessage.body.markdownText">{{referredMessage.body.markdownText}}</span>
                            <span class="url-description card-description"></span>
                            <a class="url-link  card-action" [matTooltip]="referredMessage.body.mediaUrl"
                              href="{{referredMessage.body.mediaUrl}}"
                              target="_blank">{{referredMessage.body.mediaUrl}}</a>
                          </div>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- -----------------------------audio--------------------------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'audio'"
                          class="file-type-content audio-file">
                          <div class="shared-url shared-card-content audio-player video-player p-0">
                            <div class="media-main" style="max-width: 300px">
                              <vg-player style="height: 50px;">
                                <vg-controls>
                                  <vg-play-pause></vg-play-pause>
                                  <vg-scrub-bar>
                                    <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
                                    <vg-scrub-bar-buffering-time></vg-scrub-bar-buffering-time>
                                  </vg-scrub-bar>
                                  <div class="clearfix clear"></div>
                                  <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
                                  <vg-time-display class="total-time" vgProperty="total" vgFormat="mm:ss">
                                  </vg-time-display>
                                </vg-controls>

                                <audio #audio [vgMedia]="audio" id="myAudio" preload="auto">
                                  <source [src]="referredMessage.body.attachment.mediaUrl | getFileUrl">
                                </audio>
                              </vg-player>
                            </div>
                            <!--                      <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                          </div>
                        </div>

                        <!-- -------------------------video------------------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'video'" class="file-type-content">

                          <div class="shared-url shared-card-content video-player p-0">
                            <div class="media-main">
                              <vg-player>
                                <vg-overlay-play></vg-overlay-play>
                                <vg-buffering></vg-buffering>
                                <vg-controls [vgAutohide]="true" [vgAutohideTime]="3">
                                  <vg-play-pause></vg-play-pause>
                                  <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
                                  <vg-volume></vg-volume>
                                  <vg-mute></vg-mute>
                                  <vg-fullscreen></vg-fullscreen>
                                  <mat-icon *ngIf="dispayVideoPIP" (click)="videoPIP(referredMessage.id)">
                                    picture_in_picture_alt</mat-icon>
                                  <vg-scrub-bar>
                                    <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
                                    <vg-scrub-bar-buffering-time></vg-scrub-bar-buffering-time>
                                  </vg-scrub-bar>
                                  <vg-time-display vgProperty="total" vgFormat="mm:ss"></vg-time-display>
                                </vg-controls>
                                <video #media [vgMedia]="media" id="{{referredMessage.id}}" preload="auto">
                                  <source [src]="referredMessage.body.attachment.mediaUrl | getFileUrl">
                                </video>
                              </vg-player>
                            </div>
                          </div>

                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                        <!-- ---------------------location------------------------------- -->

                        <div *ngIf="(referredMessage.body.type | lowercase) == 'location'"
                          class="file-type-content location-type">
                          <span class="display-file location-logo"
                            (click)="fullLocation(referredMessage.body.location.latitude, referredMessage.body.location.longitude)">
                            <!--                      <img src="assets/images/map-marker.svg">-->
                            <img
                              src="assets/images/{{referredMessage.header.sender.type == 'CUSTOMER' ? 'map-marker.svg' :  'map-marker-bot.svg'}}">

                          </span>
                          <div class="shared-url shared-card-content location-map">
                            <agm-map [zoom]="8" [latitude]="referredMessage.body.location.latitude"
                              [longitude]="referredMessage.body.location.longitude" controlSize="20">
                              <agm-marker [latitude]="referredMessage.body.location.latitude"
                                [longitude]="referredMessage.body.location.longitude"></agm-marker>
                            </agm-map>
                          </div>
                          <!--                    <span class="chat-time">{{referredMessage.header.timestamp | date:'shortTime'}}</span>-->
                        </div>

                      </div>
                    </div>
                  </div>
                  <div *ngIf="message.header.replyToMessageId != null" class="clear clearfix"></div>
                  <!-- -----------------------referred reply message end---------------- -->

                  <div class="chat-message-content"
                    [ngClass]="{'replied-message': message.header.replyToMessageId != null ,'file-type-message' : (message.body.type | lowercase) === 'image'||  (message.body.type | lowercase) === 'file' || (message.body.type | lowercase) === 'url' || (message.body.type | lowercase) === 'contact'|| (message.body.type | lowercase) === 'location' || (message.body.type | lowercase) === 'video' || (message.body.type | lowercase) === 'sticker', 'file-type-video' : (message.body.type | lowercase) === 'video', 'file-type-sticker' : (message.body.type | lowercase) === 'sticker' }">
                    <!-- ---------------plain---------------------- -->
                    <div *ngIf="(message.body.type | lowercase) == 'plain'">
                      <p>
                        <span [innerHTML]="message.body.markdownText | linkify | ibsformat"></span>
                        <span class="message-stamp">
                          <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                        </span>




                        <!--                    <p [innerHTML]="message.body.markdownText | linkify | ibsformat"></p>-->
                        <!--                    <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>-->

                        <button mat-icon-button class="user_settings"
                          *ngIf="((message.header.sender.type | lowercase) == 'customer') && message.botSuggestions"
                          (click)="message.showBotSuggestions =! message.showBotSuggestions ">
                        </button>
                    </div>

                    <!-- ---------------button---------------------- -->
                    <div *ngIf="(message.body.type | lowercase) == 'button'">
                      <!--                    <p [innerHTML]="message.body.markdownText | linkify | ibsformat"></p>-->
                      <!--                    <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>-->

                      <p>
                        <span [innerHTML]="message.body.markdownText | linkify | ibsformat"></span>
                        <span class="message-stamp">
                          <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                        </span>
                      </p>


                      <ul class="structured-actions">
                        <li *ngFor="let button of message.body.buttons">{{button.title}}</li>
                      </ul>
                      <button mat-icon-button class="user_settings"
                        *ngIf="((message.header.sender.type | lowercase) == 'customer') && message.botSuggestions"
                        (click)="message.showBotSuggestions =! message.showBotSuggestions ">
                      </button>
                    </div>

                    <!-- --------------------sticker--------------------- -->
                    <div *ngIf="(message.body.type | lowercase) == 'sticker'" class="file-type-content ">
                      <span class="display-file">
                        <img [src]="message.body.mediaUrl | getFileUrl">
                      </span>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- --------------------image--------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'image'" class="file-type-content image-content">
                      <a style="cursor: pointer;"
                        (click)="filePreviewOpener(message.body.attachment.mediaUrl, message.body.caption,'image' )"
                        class="display-file display-image">
                        <img [src]="message.body.attachment.mediaUrl | getFileUrl">
                      </a>
                      <div class="shared-url shared-card-content">
                        <span class="url-title card-title"
                          [matTooltip]="message.body.caption">{{message.body.caption}}</span>
                        <span class="url-description card-description"></span>
                        <a class="url-link  card-action"
                          [matTooltip]="message.body.markdownText">{{message.body.markdownText}}</a>
                      </div>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- ---------------------file-------------------------------- -->

                    <div style="cursor: pointer;"
                      (click)="filePreviewOpener(message.body.attachment.mediaUrl, message.body.additionalDetails.fileName,'file' )"
                      *ngIf="(message.body.type | lowercase) == 'file'" class="file-type-content">
                      <span class="display-file">
                        <img src="assets/file-types/{{message.body.attachment.mimeType | getFileExt}}.svg">
                      </span>
                      <span class="display-file-name">

                        <span class="show-file-name"
                          [matTooltip]="message.body.additionalDetails.fileName">{{message.body.additionalDetails.fileName}}</span>
                        <span class="file-size">{{message.body.attachment.size | getFormattedBytes}}</span>
                        <a (click)="$event.stopPropagation();" class="file-download"
                          href="{{message.body.attachment.mediaUrl | getFileUrl}}"
                          [download]="message.body.additionalDetails.fileName" [attr.disabled]="dwld.busy"
                          #dwld="wmDownload">
                          Download
                        </a>

                      </span>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- -----------------------contact---------------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'contact'" class="file-type-content contact-type">
                      <span class="display-file contact-logo">
                        <!--                      <img src="assets/images/contacts-logo.svg">-->
                        <img
                          src="assets/images/{{message.header.sender.type == 'CUSTOMER' ? 'contacts-logo.svg' :  'contacts-logo-bot.svg'}}">

                      </span>
                      <div class="contact-space shared-url shared-card-content">
                        <div class="contact-inner" *ngFor="let contact of message.body.contacts">
                          <span class="contact-name card-title"
                            [matTooltip]="contact.name.formattedName">{{contact.name.formattedName}}</span>
                          <span class="contact-number card-description">{{contact.phones[0].phone}}</span>
                        </div>
                      </div>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- ------------------------------url------------------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'url'" class="file-type-content url-content">
                      <a class="display-file url-image" href="{{message.body.mediaUrl}}" target="_blank">
                        <img src="assets/images/url.png">
                      </a>
                      <div class="shared-url shared-card-content">
                        <span class="url-title card-title"
                          [matTooltip]="message.body.markdownText">{{message.body.markdownText}}</span>
                        <span class="url-description card-description"></span>
                        <a class="url-link  card-action" [matTooltip]="message.body.mediaUrl"
                          href="{{message.body.mediaUrl}}" target="_blank">{{message.body.mediaUrl}}</a>
                      </div>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- -----------------------------audio--------------------------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'audio'" class="file-type-content audio-file">
                      <div class="shared-url shared-card-content audio-player video-player p-0">
                        <div class="media-main" style="max-width: 300px">
                          <vg-player style="height: 50px;">
                            <vg-controls>
                              <vg-play-pause></vg-play-pause>
                              <vg-scrub-bar>
                                <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
                                <vg-scrub-bar-buffering-time></vg-scrub-bar-buffering-time>
                              </vg-scrub-bar>
                              <div class="clearfix clear"></div>
                              <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
                              <vg-time-display class="total-time" vgProperty="total" vgFormat="mm:ss"></vg-time-display>
                            </vg-controls>

                            <audio #audio [vgMedia]="audio" id="myAudio" preload="auto">
                              <source [src]="message.body.attachment.mediaUrl | getFileUrl">
                            </audio>
                          </vg-player>
                        </div>
                        <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                      </div>
                    </div>

                    <!-- -------------------------video------------------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'video'" class="file-type-content">

                      <div class="shared-url shared-card-content video-player p-0">
                        <div class="media-main">
                          <vg-player>
                            <vg-overlay-play></vg-overlay-play>
                            <vg-buffering></vg-buffering>
                            <vg-controls [vgAutohide]="true" [vgAutohideTime]="3">
                              <vg-play-pause></vg-play-pause>
                              <vg-time-display vgProperty="current" vgFormat="mm:ss"></vg-time-display>
                              <vg-volume></vg-volume>
                              <vg-mute></vg-mute>
                              <vg-fullscreen></vg-fullscreen>
                              <mat-icon *ngIf="dispayVideoPIP" (click)="videoPIP(message.id)">picture_in_picture_alt
                              </mat-icon>
                              <vg-scrub-bar>
                                <vg-scrub-bar-current-time></vg-scrub-bar-current-time>
                                <vg-scrub-bar-buffering-time></vg-scrub-bar-buffering-time>
                              </vg-scrub-bar>
                              <vg-time-display vgProperty="total" vgFormat="mm:ss"></vg-time-display>
                            </vg-controls>
                            <video #media [vgMedia]="media" id="{{message.id}}" preload="auto">
                              <source [src]="message.body.attachment.mediaUrl | getFileUrl">
                            </video>
                          </vg-player>
                        </div>
                      </div>

                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                    <!-- ---------------------location------------------------------- -->

                    <div *ngIf="(message.body.type | lowercase) == 'location'" class="file-type-content location-type">
                      <span class="display-file location-logo"
                        (click)="fullLocation(message.body.location.latitude, message.body.location.longitude)">
                        <!--                      <img src="assets/images/map-marker.svg">-->
                        <img
                          src="assets/images/{{message.header.sender.type == 'CUSTOMER' ? 'map-marker.svg' :  'map-marker-bot.svg'}}">

                      </span>
                      <div class="shared-url shared-card-content location-map">
                        <agm-map [zoom]="8" [latitude]="message.body.location.latitude"
                          [longitude]="message.body.location.longitude" controlSize="20">
                          <agm-marker [latitude]="message.body.location.latitude"
                            [longitude]="message.body.location.longitude"></agm-marker>
                        </agm-map>
                      </div>
                      <span class="chat-time">{{message.header.timestamp | date:'shortTime'}}</span>
                    </div>

                  </div>
                </div>

                <div class="chat-intents" *ngIf="message.showBotSuggestions">
                  <div class="intents-inner">
                    <p *ngFor="let botSuggestion of message.botSuggestions">
                      {{botSuggestion.messageBody.markdownText}}
                      <button mat-mini-fab class="canned-trigger edit-trigger"
                        (click)="replyInput.value=botSuggestion.messageBody.markdownText">
                        <i class="material-icons">
                          edit
                        </i>
                      </button>
                      <button mat-mini-fab class="canned-trigger send-suggestion"
                        (click)="onSend(botSuggestion.messageBody.markdownText); replyInput.value = null">
                        <i class="material-icons">
                          send
                        </i>
                      </button>
                    </p>
                  </div>
                </div>
                <!-- <span class="msg-status" *ngIf="(message.header.sender.type | lowercase) == 'agent' && message.header.status=='sent' &&
                message.header.sender.participant.keycloakUser.id == _cacheService.agent.id ">
                  <mat-icon>done</mat-icon>
                </span> -->
              </div>

            </div>
            <div id="chat-area-end"></div>

          </div>
        </ng-scrollbar>
      </div>

    </div>

    <div class="chat-footer" [ngClass]="{'textarea-disable': conversation.activeChannelSessions.length == 0}">
      <div class="slide-in-bottom" *ngIf="showNewMessageNotif" (click)="downTheScrollAfterMilliSecs(0,'smooth')"
        class="new-msg-notif">New
        Message
        <span class="material-icons">
          arrow_drop_down
        </span>
      </div>
      <span class="selected-channel">Selected Channel:
        <label *ngIf="conversation.activeChannelSessions.length > 0"
          style="color:#1a50a3;">{{conversation.activeChannelSessions[conversation.activeChannelSessions.length
          -1]?.channel.channelType.name| titlecase}}</label>
        <label *ngIf="conversation.activeChannelSessions.length == 0" style="color:grey;">
          None
        </label>
      </span>

      <div class="message-composer">
        <form class="reply-form">
          <label class="count-reply">{{replyInput.value.length}}/200</label>
          <div class="mat-form-field chat-area" [ngClass]="{'expand-area-height':expanedHeight > 50}">
            <textarea [disabled]="conversation.activeChannelSessions.length == 0"
              (keyup.enter)="onSend(replyInput.value); replyInput.value = null" (click)="onTextAreaClick()"
              [attr.data-emoji-picker]="conversation.activeChannelSessions.length > 0 ? true : false"
              [(ngModel)]="message" (keyup)="onKey($event)" name="message" [matAutocomplete]="auto" matInput
              cdkTextareaAutosize cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5" id="messageTextarea" class="resize-none"
              #replyInput name="message"
              placeholder="{{conversation.messages[conversation.messages.length -1]?.botSuggestions ? 'Bot suggestions are available type / for viewing' :'Type a message here...'}}"></textarea>
            <!-- [ngClass]="{'animate-content': displaySuggestionsAnimation}" -->

            <mat-autocomplete #auto="matAutocomplete" class="suggested-answer answer-autocomplete">
              <div class="suggested-content" #mainScreen
                [ngClass]="{'content-display': cannedTabOpen || displaySuggestionsArea}">
                <!-- <div class="suggested-tab suggested-tabs-update" *ngIf="quickReplies"
                  >
                  <ng-container
                    *ngFor="let botSuggestion of conversation.messages[conversation.messages.length -1]?.botSuggestions | LockFilter: message">
                    <ng-container *ngIf="botSuggestion?.messageBody.type == 'PLAIN'">
                      <mat-option [value]="botSuggestion?.messageBody.markdownText"
                        (click)="replyInput.value=botSuggestion?.messageBody.markdownText"
                        *ngIf="botSuggestion.messageBody.markdownText != undefined">
                        {{botSuggestion.messageBody.markdownText}}
                        <button mat-mini-fab class="canned-trigger edit-trigger"
                          (click)="replyInput.value=botSuggestion.messageBody.markdownText">
                          <i class="material-icons">
                            edit
                          </i>
                        </button>
                        <button mat-mini-fab class="canned-trigger send-suggestion"
                          (click)="onSend(botSuggestion.messageBody.markdownText); replyInput.value = null">
                          <i class="material-icons">
                            send
                          </i>
                        </button>
                      </mat-option>
                    </ng-container>
                  </ng-container>
                </div> -->


                <mat-tab-group animationDuration="0ms" *ngIf="!displaySuggestionsArea && cannedTabOpen">


                  <!-- <mat-tab label="Canned Messages">
                    <div class="right-canned-message-list main-canned-message-area">
                      <div class="bar-content">

                        <mat-tab-group class="inner-tabs" animationDuration="0ms">
                          <ng-container *ngFor="let msg of cannedMessages; let i = index">
                            <mat-tab *ngIf="i<3" label="{{msg.category}}">
                              <mat-option class="custom-tab-area" [value]="cMsg"
                                *ngFor="let cMsg of msg.messages | LockFilter: message">
                                {{cMsg}}
                                {{cMsg.count}}

                                <button mat-mini-fab color="primary" class="canned-trigger edit-trigger">
                                  <i class="material-icons">
                                    edit
                                  </i>
                                </button>
                                <button mat-mini-fab color="primary" class="canned-trigger send-suggestion">
                                  <i class="material-icons">
                                    send
                                  </i>
                                </button>
                              </mat-option>

                            </mat-tab>
                          </ng-container>
                        </mat-tab-group>
                      </div>
                    </div>
                  </mat-tab> -->

                  <mat-tab label="Bot Suggestions">
                    <ng-container
                      *ngFor="let botSuggestion of conversation.messages[conversation.messages.length -1]?.botSuggestions | LockFilter: message">
                      <ng-container *ngIf="botSuggestion?.messageBody.type == 'PLAIN'">
                        <mat-option [value]="botSuggestion?.messageBody.markdownText"
                          (click)="replyInput.value=botSuggestion?.messageBody.markdownText"
                          *ngIf="botSuggestion.messageBody.markdownText != undefined">
                          {{botSuggestion.messageBody.markdownText}}
                          <button mat-mini-fab class="canned-trigger edit-trigger"
                            (click)="replyInput.value=botSuggestion.messageBody.markdownText">
                            <i class="material-icons">
                              edit
                            </i>
                          </button>
                          <button (click)="onSend(botSuggestion.messageBody.markdownText)" mat-mini-fab
                            class="canned-trigger send-suggestion">
                            <i class="material-icons">
                              send
                            </i>
                          </button>
                        </mat-option>
                      </ng-container>
                    </ng-container>
                  </mat-tab>
                </mat-tab-group>
              </div>
            </mat-autocomplete>
          </div>

          <div class="chat-composer-trigger">
            <!-- <button class="video-call composer-trigger" (click)="emoji()" mat-icon-button>
              <mat-icon>voice_chat</mat-icon>
            </button> -->
            <button (click)="onSend(replyInput.value); replyInput.value = null "
              *ngIf="replyInput.value.length > 0 && conversation.activeChannelSessions.length > 0"
              class="send-btn composer-trigger" mat-icon-button>
              <!--              <mat-icon>send</mat-icon>-->
            </button>

            <button style="cursor: pointer;" class="send-btn attachment-btn composer-trigger" mat-icon-button
              *ngIf="replyInput.value.length < 1 && conversation.activeChannelSessions.length > 0">
              <input accept=".rtf,.txt,.png,.jpg,.jpeg,.pdf,.ppt,.xlsx,.xls,.doc,.docx" multiple #myFileInput
                type="file" (change)="uploadFile($event.target.files)" name="ef_chatbox_chat_file_upload"
                id="uploadFileBtn" class="file-upload-input">
            </button>

            <!--            <span class="attachment-btn" >-->
            <!--            <input #myFileInput *ngIf="replyInput.value.length < 1" (change)="uploadFile($event.target.files)" type="file" [disabled]="chatServerDown || conversation.state =='ended'"-->
            <!--                   name="ef_chatbox_chat_file_upload" id="uploadFileBtn" class="file-upload-input">-->
            <!--            <i class="material-icons" *ngIf="replyInput.value.length < 1">-->
            <!--                attach_file-->
            <!--            </i>-->
            <!--        </span>-->

          </div>
        </form>
      </div>

    </div>

    <ng-template #noteTemplate>
      <div class="note-dialog-main">
        <div class="dialog-header">
          <h4 mat-dialog-title>{{popTitle}} <button mat-button mat-dialog-close>
              <mat-icon>close</mat-icon>
            </button></h4>
        </div>
        <div class="dialog-main-content">
          <div class="row m-0">
            <div class="col-md-4">
              <div class="categories-area divider-content">
                <h4>Categories</h4>
                <div class="selected-area">
                  <div class="select-categories">
                    <mat-chip-list>
                      <mat-chip>Doy Ortelt <mat-icon>close</mat-icon>
                      </mat-chip>
                    </mat-chip-list>
                  </div>
                </div>
                <div class="categories-label">
                  <ul>
                    <li *ngFor="let option of categories">
                      {{option}}
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="wrap-up-area divider-content">
                <h4>Wrap-Up Codes</h4>
                <div class="selected-area">
                  <div class="select-categories">
                    <mat-chip-list>
                      <mat-chip>Doy Ortelt <mat-icon>close</mat-icon>
                      </mat-chip>
                    </mat-chip-list>
                  </div>
                </div>
                <div class="categories-label">
                  <ul>
                    <li *ngFor="let option of categories">
                      {{option}}
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="note-area col-md-12">
              <h4>Notes</h4>
              <textarea></textarea>
            </div>
          </div>
        </div>

        <div class="action-trigger text-right">
          <button mat-button mat-dialog-close class="close-btn">Cancel</button>
          <button mat-button [mat-dialog-close]="true" class="success-btn" cdkFocusInitial>Apply</button>
        </div>
      </div>
    </ng-template>
  </div>

  <div class="customer-info-main">
    <app-customer-info [activeChannelSessions]="conversation.activeChannelSessions" [customer]="conversation.customer"
      [customerSuggestions]="conversation.customerSuggestions" [firstChannelSession]="conversation.firstChannelSession"
      [topicId]="conversation.topicId" (expandCustomerInfo)="eventFromChild($event)">
    </app-customer-info>
  </div>
</div>